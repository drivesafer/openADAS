<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Red Ring Sign Detector</title>
  <style>
    body{font-family:sans-serif;background:#121212;color:#fff;margin:0;padding:14px;text-align:center}
    h2{margin:8px 0 10px}
    #status{color:#ffcc00;font-weight:700;margin:8px 0 12px}
    .grid{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;max-width:1400px;margin:auto}
    .box{flex:1;min-width:320px;max-width:640px}
    canvas,video{width:100%;border-radius:10px;background:#000;border:2px solid #333}
    .label{margin:6px 0 6px;font-weight:700;color:#00ff00;text-transform:uppercase;letter-spacing:1px;font-size:13px}
    .controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:8px 0 12px}
    select{background:#1b1b1b;color:#fff;border:1px solid #444;border-radius:8px;padding:8px 10px}
  </style>
</head>
<body>
  <h2>Real-Time Red Ring Sign Detector</h2>
  <div id="status">Wait... Initializing OpenCV.js</div>

  <div class="controls">
    <select id="profile">
      <option value="auto">Profile: Auto (Day/Night)</option>
      <option value="day">Profile: Day</option>
      <option value="night">Profile: Night</option>
    </select>

    <select id="tightness">
      <option value="loose">HSV: Loose</option>
      <option value="med" selected>HSV: Medium</option>
      <option value="tight">HSV: Tight</option>
      <option value="ultra">HSV: Ultra</option>
    </select>
  </div>

  <div class="grid">
    <div class="box">
      <div class="label">Live Detection</div>
      <canvas id="canvasOutput"></canvas>
    </div>
    <div class="box">
      <div class="label">Debug Mask (Red)</div>
      <canvas id="canvasMask"></canvas>
    </div>
  </div>

  <video id="videoInput" width="640" height="480" autoplay playsinline muted style="display:none;"></video>

  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <script type="module">
    import { createRedRingDetector } from './detect.js';

    const video = document.getElementById('videoInput');
    const status = document.getElementById('status');
    const outCanvas = document.getElementById('canvasOutput');
    const maskCanvas = document.getElementById('canvasMask');
    const profileSel = document.getElementById('profile');
    const tightSel = document.getElementById('tightness');

    function waitForOpenCV() {
      return new Promise((resolve) => {
        const t = setInterval(() => {
          if (window.cv && cv.Mat) { clearInterval(t); resolve(); }
        }, 30);
      });
    }

    async function startCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { width: 640, height: 480, facingMode: "environment" },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
    }

    (async () => {
      status.textContent = "Loading OpenCV.js...";
      await waitForOpenCV();

      status.textContent = "Accessing camera...";
      try {
        await startCamera();
      } catch (e) {
        status.textContent = "Camera Error: " + e.message;
        return;
      }

      const detector = createRedRingDetector({
        video,
        outputCanvas: outCanvas,
        maskCanvas: maskCanvas,
        getUIConfig: () => ({
          profile: profileSel.value,     // auto | day | night
          tightness: tightSel.value      // loose | med | tight | ultra
        }),
        onStatus: (s) => status.textContent = s
      });

      detector.start();
      status.textContent = "System Active: Detecting...";
    })();
  </script>
</body>
</html>